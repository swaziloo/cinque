#include <stdint.h>
#include QMK_KEYBOARD_H

#ifdef OLED_ENABLE

static uint8_t display_row = 9; // max 10, animation takes 6 rows
static uint8_t k_pause_s = 3; // initial pause (in seconds)
static uint8_t k_min_pause_s = 3; // minimum pause (in seconds)
static uint8_t k_max_pause_s = 45; // maximum pause (in seconds)

static const char PROGMEM k_base[] = {
    // 'base', 32x24px
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xfe, 0x1f, 0x7f, 0x7f, 0x7f, 0xff, 0xff, 0xff, 
    0xff, 0x7f, 0x7f, 0x0e, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xc1, 0x3e, 0xff, 0xff, 0xff, 0xfe, 0x01, 0xc1, 
    0xfe, 0xff, 0xff, 0xff, 0x3c, 0xc3, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x1a, 0x13, 0x03, 0x07, 0x03, 0x12, 0x12, 0x13, 0x43, 0x0e, 0x4c, 0x17, 0x07, 0x0f, 0x04, 0x07, 
    0x07, 0x07, 0x0f, 0x0d, 0x0c, 0x0f, 0x27, 0x26, 0x20, 0x10, 0x10, 0x10, 0x18, 0x10, 0x10, 0x10
};

static const char PROGMEM k_h00[] = {
    // 'head00', 32x24px
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe0, 0xf8, 0xcc, 0x84, 0x86, 0xc6, 0xfe, 0xfe, 0xfe, 
    0xfe, 0xfe, 0xfe, 0xfc, 0xfc, 0xf8, 0xf0, 0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0xf0, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0x0f, 0x07, 0x07, 0x07, 0x0f, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x07, 0x0f, 0x1f, 0x1f, 0x3f, 0x39, 0xb0, 0xb9, 0xbf, 0x7f, 0x7f, 0x7f, 
    0x7f, 0x7f, 0x7f, 0x7f, 0x3f, 0x3e, 0x1e, 0x1e, 0x0f, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const char PROGMEM k_h10[] = {
    // 'head10', 32x24px
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe0, 0xf0, 0xf8, 0xe4, 0xc6, 0xc2, 0xc2, 0xe6, 0xfe, 
    0xfe, 0xfe, 0xfe, 0xfc, 0xfc, 0xf8, 0xf0, 0xe0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0xc0, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0x7f, 0x1f, 0x0f, 0x0f, 0x0f, 0x1f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0f, 0x1f, 0x1c, 0x38, 0xbc, 0xbf, 0x7f, 0x7f, 0x7f, 0x7f, 
    0x7f, 0x7f, 0x7f, 0x7e, 0x3c, 0x3c, 0x3c, 0x1c, 0x0f, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const char PROGMEM k_h20[] = {
    // 'head20', 32x24px
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0xf0, 0xf8, 0xfc, 0xe6, 0xc2, 0xc2, 0xe2, 0xe6, 
    0xfe, 0xfe, 0xfe, 0xfc, 0xfc, 0xfc, 0xf8, 0xf0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0xf8, 0xfe, 0xff, 0xff, 0x7f, 0x7f, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0x3f, 0x3f, 0x1f, 0x1f, 0x3f, 0xff, 0xff, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x07, 0x0e, 0x0c, 0x1e, 0xbf, 0xbf, 0x7f, 0x7f, 0x7f, 0x7f, 
    0x7f, 0x7f, 0x7f, 0x78, 0x78, 0x38, 0x38, 0x1c, 0x0f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const char PROGMEM k_h30[] = {
    // 'head30', 32x24px
    0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xe0, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0xe6, 0xc2, 0xc3, 
    0xe3, 0xe7, 0xfe, 0xfe, 0xfc, 0xfc, 0xf8, 0xf0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x7c, 0xff, 0xff, 0xff, 0x1f, 0x1f, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0x3f, 0x3f, 0x3f, 0x7f, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x06, 0x0f, 0x1f, 0xbf, 0xbf, 0x7f, 0x7f, 0x7f, 0x7f, 
    0x7f, 0x7f, 0x78, 0x70, 0x70, 0x70, 0x38, 0x1f, 0x0f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const char PROGMEM k_h40[] = {
    // 'head40', 32x24px
    0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xe0, 0xe0, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0xfe, 0xf6, 0xe3, 
    0xc3, 0xc3, 0xe6, 0xfe, 0xfc, 0xfc, 0xf8, 0xf0, 0xe0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x3e, 0xff, 0xff, 0xdf, 0x8f, 0x8f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0x7f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0f, 0x1f, 0xbf, 0x7f, 0x7f, 0x7f, 0x7f, 0xff, 
    0xff, 0xf1, 0xe0, 0xe0, 0x60, 0x70, 0x39, 0x0f, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const char PROGMEM k_h50[] = {
    // 'head50', 32x24px
    0x00, 0x00, 0x00, 0x80, 0xc0, 0xe0, 0xf0, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0xfc, 0xfc, 0xfe, 0xfe, 
    0xe6, 0xc2, 0xc2, 0xe6, 0xfc, 0xfc, 0xf8, 0xf0, 0xe0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x1f, 0x3f, 0xff, 0xe7, 0xe3, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x0f, 0x1f, 0xbf, 0xbf, 0x7f, 0x7f, 0xff, 0xff, 
    0xf1, 0xe0, 0xe0, 0xe0, 0x70, 0x39, 0x1f, 0x0f, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const char PROGMEM k_h60[] = {
    // 'head60', 32x24px
    0x00, 0x00, 0x00, 0x80, 0xc0, 0xe0, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfe, 0xfe, 
    0xfe, 0xfe, 0xc6, 0x86, 0x84, 0xcc, 0xf8, 0xf0, 0xe0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x07, 0x1f, 0xff, 0xf3, 0xf1, 0xf1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x0f, 0x1f, 0xbf, 0x7f, 0x7f, 0xff, 0xf3, 0xc1, 
    0xc1, 0xc1, 0x61, 0x63, 0x3f, 0x3f, 0x1f, 0x0f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const char* k_h_array [] = {
    k_h00, k_h10, k_h20, k_h30, k_h40, k_h50, k_h60
};

static uint8_t k_h_sizes [7] = {
    sizeof(k_h00), sizeof(k_h10), sizeof(k_h20), sizeof(k_h30), 
    sizeof(k_h40), sizeof(k_h50), sizeof(k_h60)
};

// don't change these
static uint32_t timer = 0;
static uint8_t current_frame = 0;
static uint8_t spring_frame = 0;

void render_animated_kodama(void) {
    if (timer == 0) {
        oled_set_cursor(0, display_row);
        oled_write_raw_P(k_h_array[0], k_h_sizes[0]);
        oled_set_cursor(0, (display_row + 3));
        oled_write_raw_P(k_base, sizeof(k_base));
        timer = timer_read32();
    }
    if (current_frame < 7) {
        if (timer_elapsed32(timer) > (90 + (current_frame * 2))) {
            oled_set_cursor(0, display_row);
            oled_write_raw_P(k_h_array[current_frame], k_h_sizes[current_frame]);
            current_frame++;
            timer = timer_read32();
        }
    } else if (current_frame == 7) {
        if (timer_elapsed32(timer) > 200) {
            current_frame += 2;
            timer = timer_read32();
        }
    } else if (current_frame < 21) {
        if (timer_elapsed32(timer) > (60 + (current_frame - 9))) {
            oled_set_cursor(0, display_row);
            spring_frame = (current_frame % 2 == 0) ? 6 : 0;
            oled_write_raw_P(k_h_array[spring_frame], k_h_sizes[spring_frame]);
            current_frame++;
            timer = timer_read32();
        }
    } else if (current_frame < 24 && timer_elapsed32(timer) > 70) {
        oled_set_cursor(0, display_row);
        oled_write_raw_P(k_h_array[(23 - current_frame)], k_h_sizes[(23 - current_frame)]);
        current_frame++;
        timer = timer_read32();
    } else if (current_frame == 24 && timer_elapsed32(timer) > (k_pause_s * 1000)) {
        current_frame = 0;
        timer = timer_read32();
        srand(timer);
        k_pause_s = (rand() & (k_max_pause_s - k_min_pause_s + 1)) + k_min_pause_s;
    }
}

#endif 
